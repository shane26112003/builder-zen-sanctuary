<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MetroReserve - Metro Seat Reservation System</title>
    <link rel="stylesheet" href="/styles/main.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="login-container">
      <div class="login-content">
        <div class="brand-section">
          <div class="brand-icon">
            <div class="mrs-logo">
              <span class="mrs-text">MRS</span>
              <div class="mrs-underline"></div>
            </div>
          </div>
          <h1 class="brand-title">MetroReserve</h1>
          <p class="brand-subtitle">Secure your journey with us</p>
        </div>

        <div class="login-card">
          <div class="card-header">
            <h2 class="card-title">Sign In</h2>
            <p class="card-description">
              Enter your credentials to access the metro reservation system
            </p>
          </div>

          <form id="loginForm" class="login-form">
            <div class="form-group">
              <label for="email" class="form-label">Email</label>
              <input
                type="email"
                id="email"
                class="form-input"
                placeholder="Enter your email"
                required
              />
            </div>

            <div class="form-group">
              <label for="password" class="form-label">Password</label>
              <input
                type="password"
                id="password"
                class="form-input"
                placeholder="Enter your password"
                required
              />
            </div>

            <div id="errorMessage" class="error-message" style="display: none">
              Invalid credentials. Please check your email and password.
            </div>

            <button type="submit" class="btn btn-primary" id="loginBtn">
              <span id="loginText">Sign In</span>
              <span id="loadingText" style="display: none">Signing In...</span>
            </button>
          </form>

          <div class="auth-divider">
            <span>or</span>
          </div>

          <button
            type="button"
            class="btn btn-secondary"
            id="signupBtn"
            style="width: 100%; margin-bottom: 1rem"
          >
            Create New Account
          </button>

          <div class="demo-info">
            <p>New to MetroReserve? Create an account to get started</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Supabase Auth SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      // Initialize Supabase client
      const { createClient } = supabase;
      const supabaseUrl = "https://raqgobqbkgrhvcucrbhk.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhcWdvYnFia2dyaHZjdWNyYmhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NDY0NTksImV4cCI6MjA3MTQyMjQ1OX0.XTGQmu8WNg8wg-qFyJnfLYN-uLxhPnCLfT6f4MZ8VzY";
      const supabaseClient = createClient(supabaseUrl, supabaseKey);

      // Enhanced Auth Manager with Supabase
      class SupabaseAuthManager {
        constructor() {
          this.user = null;
          this.session = null;
          this.init();
        }

        async init() {
          // Check for existing session
          const {
            data: { session },
          } = await supabaseClient.auth.getSession();
          if (session) {
            this.session = session;
            this.user = session.user;
            this.redirectBasedOnUser();
          }

          // Listen for auth changes
          supabaseClient.auth.onAuthStateChange((event, session) => {
            this.session = session;
            this.user = session?.user || null;

            if (event === "SIGNED_IN" && session) {
              this.redirectBasedOnUser();
            }
          });
        }

        async signIn(email, password) {
          try {
            const { data, error } =
              await supabaseClient.auth.signInWithPassword({
                email,
                password,
              });

            if (error) {
              console.error("Sign in error:", error);
              return { success: false, error: error.message };
            }

            return { success: true, user: data.user };
          } catch (error) {
            console.error("Sign in error:", error);
            return { success: false, error: "An unexpected error occurred" };
          }
        }

        async signUp(email, password) {
          try {
            const { data, error } = await supabaseClient.auth.signUp({
              email,
              password,
            });

            if (error) {
              console.error("Sign up error:", error);
              return { success: false, error: error.message };
            }

            // Create user profile in metro_users table
            if (data.user) {
              try {
                await this.createUserProfile(data.user.id, email);
              } catch (profileError) {
                console.warn("Could not create user profile:", profileError);
              }
            }

            return { success: true, user: data.user };
          } catch (error) {
            console.error("Sign up error:", error);
            return { success: false, error: "An unexpected error occurred" };
          }
        }

        async createUserProfile(userId, email) {
          const response = await fetch("/api/auth/create-profile", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${this.session?.access_token}`,
            },
            body: JSON.stringify({
              userId,
              email,
              userType: "general",
              hasLuggage: false,
            }),
          });

          if (!response.ok) {
            throw new Error("Failed to create user profile");
          }

          return response.json();
        }

        async signOut() {
          const { error } = await supabaseClient.auth.signOut();
          if (error) {
            console.error("Sign out error:", error);
            return false;
          }

          // Clear local storage
          localStorage.removeItem("metroUser");
          localStorage.removeItem("userBookings");

          return true;
        }

        redirectBasedOnUser() {
          if (this.user) {
            // For now, redirect to user type selection
            // Later we can check user profile to see if they've already selected their type
            window.location.href = "/user-type.html";
          }
        }

        getUser() {
          return this.user;
        }

        getSession() {
          return this.session;
        }

        isAuthenticated() {
          return !!this.user;
        }
      }

      // Initialize auth manager
      const authManager = new SupabaseAuthManager();
      window.authManager = authManager;

      // DOM event handlers
      document.addEventListener("DOMContentLoaded", function () {
        const loginForm = document.getElementById("loginForm");
        const loginBtn = document.getElementById("loginBtn");
        const signupBtn = document.getElementById("signupBtn");
        const loginText = document.getElementById("loginText");
        const loadingText = document.getElementById("loadingText");
        const errorMessage = document.getElementById("errorMessage");

        // Sign in form handler
        loginForm.addEventListener("submit", async function (e) {
          e.preventDefault();

          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;

          // Show loading state
          loginBtn.disabled = true;
          loginText.style.display = "none";
          loadingText.style.display = "inline";
          errorMessage.style.display = "none";

          // Attempt sign in
          const result = await authManager.signIn(email, password);

          if (result.success) {
            // Success - authManager will handle redirect
          } else {
            // Show error
            errorMessage.textContent = result.error;
            errorMessage.style.display = "block";

            // Reset loading state
            loginBtn.disabled = false;
            loginText.style.display = "inline";
            loadingText.style.display = "none";
          }
        });

        // Sign up button handler
        signupBtn.addEventListener("click", async function () {
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;

          if (!email || !password) {
            errorMessage.textContent =
              "Please enter email and password to create an account";
            errorMessage.style.display = "block";
            return;
          }

          if (password.length < 6) {
            errorMessage.textContent =
              "Password must be at least 6 characters long";
            errorMessage.style.display = "block";
            return;
          }

          // Show loading state
          signupBtn.disabled = true;
          signupBtn.textContent = "Creating Account...";
          errorMessage.style.display = "none";

          // Attempt sign up
          const result = await authManager.signUp(email, password);

          if (result.success) {
            // Show success message
            errorMessage.style.backgroundColor = "#f0f9ff";
            errorMessage.style.borderColor = "#bae6fd";
            errorMessage.style.color = "#0369a1";
            errorMessage.textContent =
              "Account created successfully! Please check your email to verify your account, then sign in.";
            errorMessage.style.display = "block";

            // Clear form
            document.getElementById("email").value = "";
            document.getElementById("password").value = "";
          } else {
            // Show error
            errorMessage.textContent = result.error;
            errorMessage.style.display = "block";
          }

          // Reset loading state
          signupBtn.disabled = false;
          signupBtn.textContent = "Create New Account";
        });
      });
    </script>
  </body>
</html>
